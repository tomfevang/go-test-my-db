# Comparison config: generated-columns vs star-schema
# Usage: go-seed-my-db compare benchmarks/comparison.yaml --dsn ...

configs:
  - label: generated
    file: config-generated.yaml
  - label: star
    file: config-star.yaml

tests:
  # --- Shared tests (both schemas) ---

  - name: "company + severity"
    repeat: 100
    queries:
      generated: |-
        SELECT id, _severity, date, status FROM AccountAnomaly WHERE companyId = {{Number 1 100}} AND _severity = '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}'
      star: |-
        SELECT a.id, s.name AS severity, a.date, st.name AS status FROM AccountAnomalyStar a JOIN DimSeverity s ON s.id = a.severityId JOIN DimStatus st ON st.id = a.statusId WHERE a.companyId = {{Number 1 100}} AND a.severityId = {{Number 1 4}}

  - name: "company + severity + date"
    repeat: 100
    queries:
      generated: |-
        SELECT id, _severity, date, status FROM AccountAnomaly WHERE companyId = {{Number 1 100}} AND _severity = '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}' AND date >= '2024-01-01'
      star: |-
        SELECT a.id, s.name AS severity, a.date, st.name AS status FROM AccountAnomalyStar a JOIN DimSeverity s ON s.id = a.severityId JOIN DimStatus st ON st.id = a.statusId WHERE a.companyId = {{Number 1 100}} AND a.severityId = {{Number 1 4}} AND a.date >= '2024-01-01'

  - name: "company + severity + status + date"
    repeat: 100
    queries:
      generated: |-
        SELECT id, _severity, date, status FROM AccountAnomaly WHERE companyId = {{Number 1 100}} AND _severity = '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}' AND status = '{{RandomString (SliceString "OPEN" "INVESTIGATING" "RESOLVED" "DISMISSED")}}' AND date >= '2024-01-01'
      star: |-
        SELECT a.id, s.name AS severity, a.date, st.name AS status FROM AccountAnomalyStar a JOIN DimSeverity s ON s.id = a.severityId JOIN DimStatus st ON st.id = a.statusId WHERE a.companyId = {{Number 1 100}} AND a.severityId = {{Number 1 4}} AND a.statusId = {{Number 1 4}} AND a.date >= '2024-01-01'

  - name: "company + amount range"
    repeat: 100
    queries:
      generated: |-
        SELECT id, _amount, status FROM AccountAnomaly WHERE companyId = {{Number 1 100}} AND _amount > 90
      star: |-
        SELECT a.id, a.amount, st.name AS status FROM AccountAnomalyStar a JOIN DimStatus st ON st.id = a.statusId WHERE a.companyId = {{Number 1 100}} AND a.amount > 90

  - name: "company + status + amount"
    repeat: 100
    queries:
      generated: |-
        SELECT id, _severity, _amount, status FROM AccountAnomaly WHERE companyId = {{Number 1 100}} AND status = '{{RandomString (SliceString "OPEN" "INVESTIGATING" "RESOLVED" "DISMISSED")}}' AND _amount > 90
      star: |-
        SELECT a.id, s.name AS severity, a.amount, st.name AS status FROM AccountAnomalyStar a JOIN DimSeverity s ON s.id = a.severityId JOIN DimStatus st ON st.id = a.statusId WHERE a.companyId = {{Number 1 100}} AND a.statusId = {{Number 1 4}} AND a.amount > 90

  - name: "ORDER BY: severity + date (indexed)"
    repeat: 100
    queries:
      generated: |-
        SELECT id, _severity, date FROM AccountAnomaly WHERE companyId = {{Number 1 100}} AND _severity = '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}' ORDER BY date LIMIT 50
      star: |-
        SELECT a.id, s.name AS severity, a.date FROM AccountAnomalyStar a JOIN DimSeverity s ON s.id = a.severityId WHERE a.companyId = {{Number 1 100}} AND a.severityId = {{Number 1 4}} ORDER BY a.date LIMIT 50

  - name: "ORDER BY: severity + amount (filesort)"
    repeat: 100
    queries:
      generated: |-
        SELECT id, _severity, _amount FROM AccountAnomaly WHERE companyId = {{Number 1 100}} AND _severity = '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}' ORDER BY _amount LIMIT 50
      star: |-
        SELECT a.id, s.name AS severity, a.amount FROM AccountAnomalyStar a JOIN DimSeverity s ON s.id = a.severityId WHERE a.companyId = {{Number 1 100}} AND a.severityId = {{Number 1 4}} ORDER BY a.amount LIMIT 50

  - name: "ORDER BY: status + date (scan + filesort)"
    repeat: 100
    queries:
      generated: |-
        SELECT id, status, date FROM AccountAnomaly WHERE companyId = {{Number 1 100}} AND status = '{{RandomString (SliceString "OPEN" "INVESTIGATING" "RESOLVED" "DISMISSED")}}' ORDER BY date LIMIT 50
      star: |-
        SELECT a.id, st.name AS status, a.date FROM AccountAnomalyStar a JOIN DimStatus st ON st.id = a.statusId WHERE a.companyId = {{Number 1 100}} AND a.statusId = {{Number 1 4}} ORDER BY a.date LIMIT 50

  - name: "join: severity + region"
    repeat: 100
    queries:
      generated: |-
        SELECT a.id, a._severity, a.date, c.anomalyType FROM AccountAnomaly a JOIN AccountCheck c ON a.accountCheckId = c.id WHERE a.companyId = {{Number 1 100}} AND a._severity = '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}' AND c._region = '{{RandomString (SliceString "EMEA" "APAC" "NAM" "LATAM")}}'
      star: |-
        SELECT a.id, s.name AS severity, a.date, c.anomalyType FROM AccountAnomalyStar a JOIN DimSeverity s ON s.id = a.severityId JOIN AccountCheckStar c ON a.accountCheckId = c.id WHERE a.companyId = {{Number 1 100}} AND a.severityId = {{Number 1 4}} AND c.regionId = {{Number 1 4}}

  - name: "agg: GROUP BY severity"
    repeat: 100
    queries:
      generated: |-
        SELECT _severity, COUNT(*) AS cnt FROM AccountAnomaly WHERE companyId = {{Number 1 100}} GROUP BY _severity
      star: |-
        SELECT s.name AS severity, COUNT(*) AS cnt FROM AccountAnomalyStar a JOIN DimSeverity s ON s.id = a.severityId WHERE a.companyId = {{Number 1 100}} GROUP BY a.severityId

  - name: "agg: filtered GROUP BY status"
    repeat: 100
    queries:
      generated: |-
        SELECT status, COUNT(*), AVG(_amount) FROM AccountAnomaly WHERE companyId = {{Number 1 100}} AND _severity = '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}' GROUP BY status
      star: |-
        SELECT st.name AS status, COUNT(*), AVG(a.amount) FROM AccountAnomalyStar a JOIN DimStatus st ON st.id = a.statusId WHERE a.companyId = {{Number 1 100}} AND a.severityId = {{Number 1 4}} GROUP BY a.statusId

  # --- Config-specific tests ---

  - name: "json-path: company + severity"
    repeat: 100
    queries:
      generated: |-
        SELECT id, details->>'$.severity' AS severity, date, status FROM AccountAnomaly WHERE companyId = {{Number 1 100}} AND details->>'$.severity' = '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}'

  - name: "json-path: company + amount range"
    repeat: 100
    queries:
      generated: |-
        SELECT id, CAST(details->>'$.amount' AS SIGNED) AS amount, status FROM AccountAnomaly WHERE companyId = {{Number 1 100}} AND CAST(details->>'$.amount' AS SIGNED) > 90

  - name: "json-path: GROUP BY severity"
    repeat: 100
    queries:
      generated: |-
        SELECT details->>'$.severity' AS severity, COUNT(*) AS cnt FROM AccountAnomaly WHERE companyId = {{Number 1 100}} GROUP BY details->>'$.severity'

  - name: "star: bare filter (no JOINs)"
    repeat: 100
    queries:
      star: |-
        SELECT a.id, a.severityId, a.date, a.statusId FROM AccountAnomalyStar a WHERE a.companyId = {{Number 1 100}} AND a.severityId = {{Number 1 4}}
