options:
  schema: "benchmarks/schema-inv.sql"
  rows: 100000

tables:
  AccountAnomalyInv:
    columns:
      accountCheckId: "{{Number 1 100000}}"
      date: '{{printf "%04d-%02d-%02d" (Number 2020 2025) (Number 1 12) (Number 1 28)}}'
      message: "{{HackerPhrase}}"

  AnomalySeverity:
    columns:
      anomalyId: "{{Number 1 100000}}"
      severity: '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}'

  AnomalyStatus:
    columns:
      anomalyId: "{{Number 1 100000}}"
      status: '{{RandomString (SliceString "OPEN" "INVESTIGATING" "RESOLVED" "DISMISSED")}}'

  AnomalyAmount:
    columns:
      anomalyId: "{{Number 1 100000}}"
      amount: "{{Number 0 100}}"

tests:
  # --- JOIN scaling: how cost grows with each attribute table JOIN ---
  - name: "1 JOIN: severity"
    query: |-
      SELECT a.id, s.severity, a.date FROM AccountAnomalyInv a JOIN AnomalySeverity s ON s.anomalyId = a.id WHERE s.severity = '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}'
    repeat: 100
  - name: "1 JOIN + date: severity + date"
    query: |-
      SELECT a.id, s.severity, a.date FROM AccountAnomalyInv a JOIN AnomalySeverity s ON s.anomalyId = a.id WHERE s.severity = '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}' AND a.date >= '2024-01-01'
    repeat: 100
  - name: "2 JOINs: severity + status"
    query: |-
      SELECT a.id, s.severity, st.status, a.date FROM AccountAnomalyInv a JOIN AnomalySeverity s ON s.anomalyId = a.id JOIN AnomalyStatus st ON st.anomalyId = a.id WHERE s.severity = '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}' AND st.status = '{{RandomString (SliceString "OPEN" "INVESTIGATING" "RESOLVED" "DISMISSED")}}'
    repeat: 100
  - name: "2 JOINs + date: severity + status + date"
    query: |-
      SELECT a.id, s.severity, st.status, a.date FROM AccountAnomalyInv a JOIN AnomalySeverity s ON s.anomalyId = a.id JOIN AnomalyStatus st ON st.anomalyId = a.id WHERE s.severity = '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}' AND st.status = '{{RandomString (SliceString "OPEN" "INVESTIGATING" "RESOLVED" "DISMISSED")}}' AND a.date >= '2024-01-01'
    repeat: 100
  - name: "3 JOINs: severity + status + amount"
    query: |-
      SELECT a.id, s.severity, st.status, am.amount FROM AccountAnomalyInv a JOIN AnomalySeverity s ON s.anomalyId = a.id JOIN AnomalyStatus st ON st.anomalyId = a.id JOIN AnomalyAmount am ON am.anomalyId = a.id WHERE s.severity = '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}' AND st.status = '{{RandomString (SliceString "OPEN" "INVESTIGATING" "RESOLVED" "DISMISSED")}}' AND am.amount > 90
    repeat: 100

  # --- EXISTS subquery vs JOIN (semi-join optimization test) ---
  - name: "EXISTS: severity"
    query: |-
      SELECT a.id, a.date FROM AccountAnomalyInv a WHERE EXISTS (SELECT 1 FROM AnomalySeverity s WHERE s.anomalyId = a.id AND s.severity = '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}')
    repeat: 100
  - name: "EXISTS: severity + status"
    query: |-
      SELECT a.id, a.date FROM AccountAnomalyInv a WHERE EXISTS (SELECT 1 FROM AnomalySeverity s WHERE s.anomalyId = a.id AND s.severity = '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}') AND EXISTS (SELECT 1 FROM AnomalyStatus st WHERE st.anomalyId = a.id AND st.status = '{{RandomString (SliceString "OPEN" "INVESTIGATING" "RESOLVED" "DISMISSED")}}')
    repeat: 100

  # --- Off-index: no severity prefix, different access paths ---
  - name: "off-index: amount range (1 JOIN)"
    query: "SELECT a.id, a.date, am.amount FROM AccountAnomalyInv a JOIN AnomalyAmount am ON am.anomalyId = a.id WHERE am.amount > 90"
    repeat: 100
  - name: "off-index: status + amount (2 JOINs)"
    query: |-
      SELECT a.id, st.status, a.date, am.amount FROM AccountAnomalyInv a JOIN AnomalyStatus st ON st.anomalyId = a.id JOIN AnomalyAmount am ON am.anomalyId = a.id WHERE st.status = '{{RandomString (SliceString "OPEN" "INVESTIGATING" "RESOLVED" "DISMISSED")}}' AND am.amount > 90
    repeat: 100

  # --- ORDER BY: filesort cost with increasing JOINs ---
  - name: "1 JOIN ORDER BY date"
    query: |-
      SELECT a.id, s.severity, a.date FROM AccountAnomalyInv a JOIN AnomalySeverity s ON s.anomalyId = a.id WHERE s.severity = '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}' ORDER BY a.date LIMIT 50
    repeat: 100
  - name: "3 JOINs ORDER BY date"
    query: |-
      SELECT a.id, s.severity, st.status, am.amount FROM AccountAnomalyInv a JOIN AnomalySeverity s ON s.anomalyId = a.id JOIN AnomalyStatus st ON st.anomalyId = a.id JOIN AnomalyAmount am ON am.anomalyId = a.id WHERE s.severity = '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}' AND st.status = '{{RandomString (SliceString "OPEN" "INVESTIGATING" "RESOLVED" "DISMISSED")}}' ORDER BY a.date LIMIT 50
    repeat: 100

  # --- Aggregation (no templates â€” GROUP BY touches all values anyway) ---
  - name: "agg: GROUP BY severity (1 JOIN)"
    query: "SELECT s.severity, COUNT(*) AS cnt FROM AccountAnomalyInv a JOIN AnomalySeverity s ON s.anomalyId = a.id GROUP BY s.severity"
    repeat: 100
  - name: "agg: filtered GROUP BY status (3 JOINs)"
    query: |-
      SELECT st.status, COUNT(*), AVG(am.amount) FROM AccountAnomalyInv a JOIN AnomalySeverity s ON s.anomalyId = a.id JOIN AnomalyStatus st ON st.anomalyId = a.id JOIN AnomalyAmount am ON am.anomalyId = a.id WHERE s.severity = '{{RandomString (SliceString "LOW" "MEDIUM" "HIGH" "CRITICAL")}}' GROUP BY st.status
    repeat: 100
